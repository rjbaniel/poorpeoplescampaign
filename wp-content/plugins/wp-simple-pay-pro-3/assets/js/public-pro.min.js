/*! WP Simple Pay Pro 3 - 3.1.7
 * https://wpsimplepay.com/
 * Copyright (c) Moonstone Media 2017
 * Licensed GPLv2+ */

var simpayAppPro={};!function(a){"use strict";var b=a(document.body);simpayAppPro={init:function(){console.log("simpayAppPro initialized"),b.on("simpayFormVarsInitialized",function(a,b,c){simpayAppPro.setupValidation(b,c)}),b.on("simpayBindEventsAndTriggers",simpayAppPro.processForm),b.on("simpayFinalizeAmount",simpayAppPro.setFinalAmount)},processForm:function(a,b,c){c=simpayApp.spFormData[c.formId],c.taxAmount=simpayAppPro.calculateTaxAmount(c.amount,c.taxPercent),c.isSubscription&&"single"===c.subscriptionType&&(c.planAmount=c.amount),c.couponCode="",b.find(".simpay-custom-amount-input").on("keyup.simpayCustomAmountInput change.simpayCustomAmountInput",function(a){simpayAppPro.processCustomAmountInput(b,c),simpayAppPro.updateTotalAmount(b,c)}),b.find(".simpay-apply-coupon").on("click.simpayApplyCoupon",function(a){a.preventDefault(),simpayAppPro.applyCoupon(b,c),simpayAppPro.updateTotalAmount(b,c)}),b.find(".simpay-remove-coupon").on("click.simpayRemoveCoupon",function(a){a.preventDefault(),simpayAppPro.removeCoupon(b,c)}),b.find(".simpay-amount-dropdown, .simpay-amount-radio").on("change.simpayAmountSelect",function(a){simpayAppPro.updateAmountSelect(b,c)}),b.find(".simpay-quantity-dropdown, .simpay-quantity-radio").on("change.simpayQuantitySelect",function(){simpayAppPro.updateQuantitySelect(b,c)}),b.find(".simpay-quantity-input").on("keyup.simpayNumberQuantity, change.simpayNumberQuantity, input.simpayNumberQuantity",function(a){simpayAppPro.updateQuantitySelect(b,c),simpayAppPro.updateTotalAmount(b,c)}),b.find(".simpay-multi-sub, .simpay-plan-wrapper select").on("change.simpayMultiPlan",function(a){simpayAppPro.changeMultiSubAmount(b,c)}),b.find(".simpay-custom-amount-input").on("focus.simpayCustomAmountFocus",function(a){simpayAppPro.handleCustomAmountFocus(b,c)}),b.on("simpayCouponApplied",function(a){simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayCouponRemoved",function(a){simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayDropdownAmountChange",function(a){""===c.couponCode.trim()&&simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayRadioAmountChange",function(a){""===c.couponCode.trim()&&simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayDropdownQuantityChange",function(a){""===c.couponCode.trim()&&simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayRadioQuantityChange",function(a){""===c.couponCode.trim()&&simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayNumberQuantityChange",function(a){""===c.couponCode.trim()&&simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayMultiPlanChanged",function(a){""===c.couponCode.trim()&&simpayAppPro.updateTotalAmount(b,c)}),b.on("simpayBeforeStripePayment",function(a,b,c){simpayAppPro.submitPayment(b,c)}),simpayAppPro.initDateField(b,c),b.find(".simpay-custom-amount-input").trigger("change.simpayCustomAmountInput"),b.find(".simpay-amount-dropdown, .simpay-amount-radio").trigger("change.simpayAmountSelect"),b.find(".simpay-quantity-dropdown, .simpay-quantity-radio").trigger("change.simpayQuantitySelect"),b.find(".simpay-multi-sub:checked, .simpay-plan-wrapper select:selected").trigger("change.simpayMultiPlan"),b.find(".simpay-quantity-input").trigger("input.simpayNumberQuantity"),c.isSubscription&&"single"===c.subscriptionType&&simpayAppPro.updateRecurringAmount(b,c),simpayAppPro.updateTotalAmount(b,c)},handleCustomAmountFocus:function(a,b){var c=a.find(".simpay-custom-plan-option"),d=a.find(".simpay-custom-amount-input");spShared.debugLog("Custom Amount Focus hit",a),c.is("input")?c.prop("checked",!0):c.is("option")&&c.prop("selected",!0),b.useCustomPlan=!0,a.find(".simpay-has-custom-plan").val("true"),b.customPlanAmount=simpayApp.convertToCents(d.val()),spShared.debugLog("formData.subMinAmount",b.subMinAmount)},submitPayment:function(a,b){b.isTrial&&0===b.finalAmount?b.stripeParams.panelLabel=b.freeTrialButtonText:b.stripeParams.panelLabel=b.oldPanelLabel},setupValidation:function(a){var b=a.data("simpay-form-id");jQuery.validator.addMethod("minCheck",function(a,b,c){var d=spShared.unformatCurrency(a),e=spShared.unformatCurrency(c);return this.optional(b)||parseFloat(d)>=parseFloat(e)||""===d}),a.validate({errorPlacement:function(b,c){var d=a.find(c).data("error");d?a.find(d).append(b):b.insertAfter(a.find(c))},rules:{simpay_custom_amount:{required:!0,minCheck:simpayApp.formatMoney(spShared.unformatCurrency(simplePayForms[b].form.integers.minAmount))},simpay_subscription_custom_amount:{required:!0,minCheck:simpayApp.formatMoney(spShared.unformatCurrency(simplePayForms[b].form.integers.subMinAmount))}},messages:{simpay_custom_amount:simplePayForms[b].form.i18n.minCustomAmountError,simpay_subscription_custom_amount:simplePayForms[b].form.i18n.subMinCustomAmountError}})},initDateField:function(a,b){a.find(".simpay-date-input").datepicker(),a.find(".simpay-date-input").datepicker("option","dateFormat",b.dateFormat)},processCustomAmountInput:function(a,b){var c=a.find(".simpay-custom-amount-input").val();b.customAmount=simpayApp.convertToCents(spShared.unformatCurrency(c)),b.isSubscription&&(b.customPlanAmount=b.customAmount,b.planAmount=b.customAmount),simpayAppPro.applyCoupon(a,b)},setFinalAmount:function(a,b,c){var d=c.amount;"undefined"!==c.customAmount&&c.customAmount>0&&(d=spGeneral.booleans.isZeroDecimal?parseInt(c.customAmount):parseFloat(c.customAmount)),void 0!==c.isSubscription&&c.isSubscription&&(d="single"===c.subscriptionType?void 0!==c.customPlanAmount?c.customPlanAmount:c.amount:void 0!==c.useCustomPlan&&c.useCustomPlan?c.customPlanAmount:c.planAmount,c.isTrial&&(d=0),void 0!==c.setupFee&&(d+=c.setupFee),void 0!==c.planSetupFee&&(d+=c.planSetupFee)),void 0!==c.quantity&&(d*=c.quantity),void 0!==c.discount&&(d-=c.discount),void 0===c.isSubscription||c.isSubscription||(spShared.debugLog("percentage fee",c.feePercent),c.feePercent>0&&(d+=d*(c.feePercent/100)),spShared.debugLog("amount fee",c.feeAmount),c.feeAmount>0&&(d+=c.feeAmount)),c.taxPercent>0&&(c.isTrial?c.taxAmount=simpayAppPro.calculateTaxAmount(c.planAmount,c.taxPercent):(c.taxAmount=simpayAppPro.calculateTaxAmount(d,c.taxPercent),d+=c.taxAmount),c.taxAmount=c.taxAmount.toFixed(0),b.find(".simpay-tax-amount").val(c.taxAmount)),c.finalAmount=d},applyCoupon:function(b,c){var d=b.find(".simpay-coupon-field"),e=null,f=b.find(".simpay-coupon-message"),g=b.find(".simpay-coupon-loading"),h=b.find(".simpay-remove-coupon"),i=b.find(".simpay-coupon"),j="",k="",l=c.amount;if(d.val())j=d.val();else{if(!c.couponCode)return;j=c.couponCode}c.isSubscription&&(l=c.useCustomPlan?c.customPlanAmount:c.planAmount),"undefined"!==c.customAmount&&c.customAmount>0&&(l=c.customAmount),void 0!==c.quantity&&(l*=c.quantity),e={action:"simpay_get_coupon",coupon:j,amount:l,couponNonce:b.find("#simpay_coupon_nonce").val()},f.text(""),h.hide(),d.val(""),g.show(),a.ajax({url:spGeneral.strings.ajaxurl,method:"POST",data:e,dataType:"json",success:function(d){spShared.debugLog("coupon discount",d.discount),c.couponCode=j,c.discount=d.discount,k=d.coupon.code+": ","percent"===d.coupon.type?k+=d.coupon.amountOff+spGeneral.i18n.couponPercentOffText:"amount"===d.coupon.type&&(k+=simpayApp.formatMoney(simpayApp.convertToCents(d.coupon.amountOff))+" "+spGeneral.i18n.couponAmountOffText),a(".coupon-details").remove(),f.append(k),a("<input />",{name:"simpay_coupon_details",type:"hidden",value:k,class:"simpay-coupon-details"}).appendTo(f),h.show(),i.val(j),g.hide(),b.trigger("simpayCouponApplied")},error:function(b){var c="";spShared.debugLog("coupon error",b.responseText),b.responseText&&(c=b.responseText),f.append(a("<p />").addClass("simpay-field-error").text(c)),g.hide()}})},removeCoupon:function(a,b){a.find(".simpay-coupon-loading").hide(),a.find(".simpay-remove-coupon").hide(),a.find(".simpay-coupon-message").text(""),a.find(".simpay-coupon").val(""),b.couponCode="",b.discount=0,a.trigger("simpayCouponRemoved")},updateAmountSelect:function(a,b){a.find(".simpay-amount-dropdown").length?(b.amount=a.find(".simpay-amount-dropdown").find("option:selected").data("amount"),a.trigger("simpayDropdownAmountChange")):a.find(".simpay-amount-radio")&&(b.amount=a.find(".simpay-amount-radio").find('input[type="radio"]:checked').data("amount"),a.trigger("simpayRadioAmountChange")),simpayAppPro.applyCoupon(a,b)},updateQuantitySelect:function(a,b){b.quantity=1,a.find(".simpay-quantity-dropdown").length?(b.quantity=a.find(".simpay-quantity-dropdown").find("option:selected").data("quantity"),a.trigger("simpayDropdownQuantityChange")):a.find(".simpay-quantity-radio").length?(b.quantity=a.find(".simpay-quantity-radio").find('input[type="radio"]:checked').data("quantity"),a.trigger("simpayRadioQuantityChange")):a.find(".simpay-quantity-input").length&&(b.quantity=parseInt(a.find(".simpay-quantity-input").val()),a.trigger("simpayNumberQuantityChange")),b.quantity<1&&(b.quantity=1),a.find(".simpay-quantity").val(b.quantity),simpayAppPro.applyCoupon(a,b)},updateTotalAmount:function(a,b){simpayAppPro.setFinalAmount(null,a,b),a.find(".simpay-total-amount-value").text(simpayApp.formatMoney(b.finalAmount)),simpayAppPro.updateRecurringAmount(a,b),simpayAppPro.updateTaxAmount(a,b)},updateRecurringAmount:function(a,b){var c=b.planAmount*b.quantity+b.taxAmount;spShared.debugLog("quantity:",b.quantity),b.planIntervalCount>1?a.find(".simpay-total-amount-recurring-value").text(simpayApp.formatMoney(c)+" every "+b.planIntervalCount+" "+b.planInterval+"s"):a.find(".simpay-total-amount-recurring-value").text(simpayApp.formatMoney(c)+"/"+b.planInterval)},updateTaxAmount:function(a,b){a.find(".simpay-tax-amount-value").text(simpayApp.formatMoney(b.taxAmount))},calculateTaxAmount:function(a,b){return a*(b/100)},changeMultiSubAmount:function(a,b){var c="",d=a.find(".simpay-custom-amount-input"),e=a.find(".simpay-plan-wrapper"),f=e.find(".simpay-multi-sub"),g=0,h="",i=0,j="",k=1,l=!1,m=0;f.first().is("option")?(c=f.filter(":selected"),h=c.data("plan-id"),g=c.data("plan-setup-fee"),i=c.data("plan-amount"),j=c.data("plan-interval"),k=c.data("plan-interval-count"),l=void 0!==c.data("plan-trial"),m=c.data("plan-max-charges"),"simpay_custom_plan"===c.val()?(b.useCustomPlan=!0,i=simpayApp.convertToCents(d.val())):b.useCustomPlan=!1,l&&(b.amount=0)):(c=f.filter(":checked"),h=c.data("plan-id"),g=c.data("plan-setup-fee"),i=c.data("plan-amount"),j=c.data("plan-interval"),k=c.data("plan-interval-count"),l=void 0!==c.data("plan-trial"),m=c.data("plan-max-charges"),"simpay_custom_plan"===c.val()?(b.useCustomPlan=!0,i=simpayApp.convertToCents(d.val())):b.useCustomPlan=!1,l&&(b.amount=0)),b.planId=h,b.planSetupFee=g,b.planAmount=i,b.planInterval=j,b.planIntervalCount=k,b.isTrial=l,c.hasClass("simpay-custom-plan-option")?a.find(".simpay-has-custom-plan").val("true"):a.find(".simpay-has-custom-plan").val(""),d.val(simpayApp.convertFromCents(i)),b.useCustomPlan&&d.focus(),a.find(".simpay-multi-plan-id").val(h),a.find(".simpay-multi-plan-setup-fee").val(g),a.find(".simpay-max-charges").val(m),a.trigger("simpayMultiPlanChanged"),simpayAppPro.applyCoupon(a,b)}},b.on("simpayInit",simpayAppPro.init())}(jQuery);